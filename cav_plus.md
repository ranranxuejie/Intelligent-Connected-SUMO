# CAV Plus 程序逻辑解释

## 1. 概述
CAV Plus 是一个智能交通仿真程序，用于模拟和测试**智能网联汽车（CAV）** 在交叉口的协同控制策略。它可以实现两种核心功能：
- **信号优先**：让CAV车辆获得更长的绿灯时间或更快的红灯切换
- **轨迹/编队控制**：让CAV车辆保持安全距离，形成紧密的车队行驶

## 2. 运行方式
程序通过命令行参数来控制不同功能的开启或关闭，使用方法如下：

| 参数 | 作用 | 默认值 |
|------|------|--------|
| --signal | 启用信号优先功能 | 关闭 |
| --traj | 启用轨迹/编队控制 | 关闭 |
| --scale | 调整交通流量大小 | 1.0（正常流量） |
| --gui | 显示可视化界面 | 关闭 |

**使用示例**：
```
python cav_plus.py --signal --traj --gui --scale 1.5
```
这个命令表示：启用信号优先和轨迹控制，显示可视化界面，交通流量为正常的1.5倍。

## 3. 模拟设置
程序启动时会自动完成以下准备工作：

1. **选择运行模式**：根据是否使用GUI，选择对应的SUMO仿真引擎
2. **配置输出文件**：创建一个专门的文件夹，用于保存仿真结果数据
3. **设置仿真参数**：配置仿真步长、车辆长度等基础参数
4. **初始化交通灯**：加载预设的交通信号灯配置

## 4. 核心参数
程序中有一些重要的配置值，影响着仿真效果：

| 参数 | 含义 | 设置值 |
|------|------|--------|
| 最大车速 | CAV车辆的最高行驶速度 | 16.67 m/s（约60 km/h） |
| 绿灯最长延长时间 | 一次绿灯最多可以延长多久 | 15秒 |
| 交通压力阈值 | 判断道路拥堵的标准（车辆数） | 15辆 |
| 检测距离 | 检测车辆是否需要信号优先的范围 | 200米 |
| 虚拟停止线 | 提前停车的参考位置 | 距离实际停止线30米 |
| 安全距离 | 车辆之间的最小安全间距 | 2.0米 |

## 5. 核心功能

### 5.1 车速控制
程序使用**五次多项式算法**来实现车辆的平滑加速和减速，避免急加速急刹车。这种算法能让车辆的运动更加自然，就像人类驾驶员一样平稳操作。

#### 5.1.1 核心算法原理
五次多项式是一种数学公式，可以描述一条平滑的曲线，用于规划车辆的速度变化。它的基本形式是：

```
x(t) = c0 + c1×t + c2×t² + c3×t³ + c4×t⁴ + c5×t⁵
```

其中：
- `x(t)` 表示车辆在时间t的位置
- `c0`到`c5`是多项式系数，决定了曲线的形状
- `t` 是时间

通过调整这些系数，可以实现从当前状态到目标状态的平滑过渡。

#### 5.1.2 停车模式
当车辆需要停下来时（如遇到红灯），程序会执行以下步骤：

1. **计算刹车距离**：确定从当前位置到停止线的精确距离
2. **估算刹车时间**：
   - 如果当前速度较高，使用公式：`T0 = 2S / v0`（S是距离，v0是当前速度）
   - 如果当前速度很低，使用公式：`T0 = 2×√(S)`（更温和的刹车）
3. **调整刹车曲线**：根据设定的"刹车形状因子"调整刹车的平滑程度
   - 形状因子 > 1：刹车更平缓，时间更长
   - 形状因子 < 1：刹车更急，时间更短
4. **计算五次多项式系数**：通过解方程组，得到使车辆刚好停在停止线的多项式系数
5. **计算下一刻速度**：根据多项式计算出下一时刻的目标速度

**停车模式关键参数**：
- 静止速度阈值：0.1 m/s（低于这个速度就算停车）
- 停车距离死区：0.5 m（接近停止线时直接停车）
- 刹车形状因子：1.5（默认值，提供平滑刹车体验）

#### 5.1.3 跟车/巡航模式
当车辆正常行驶时，程序会根据前车情况调整速度：

1. **判断前车状态**：
   - 如果与前车速度差小于0.5 m/s，直接跟随前车速度
   - 如果前车停止且自身也停止，保持静止（防溜车逻辑）
2. **计算期望间距**：
   ```
   期望间距 = 静止安全距离 + 当前速度 × 时距
   ```
   - 静止安全距离：2.0 m（车辆停止时的最小间距）
   - 时距：0.5 s（保持当前速度下0.5秒的行驶距离）
3. **计算跟车速度**：
   ```
   跟车速度 = 前车速度 + 间距误差 × 跟车增益
   ```
   - 间距误差：当前间距与期望间距的差值
   - 跟车增益：0.1（控制跟车响应的灵敏度）
4. **应用安全限制**：
   - 舒适刹车限制：确保刹车时的减速度不超过1.5 m/s²
   - 紧急刹车限制：确保在紧急情况下能安全停下，减速度不超过5.0 m/s²
5. **使用五次多项式平滑过渡**：计算从当前速度到目标速度的平滑加速/减速曲线

**跟车模式关键参数**：
- 跟车增益：0.1（数值越大，对间距变化的响应越敏感）
- 舒适减速度：1.5 m/s²（正常刹车的最大减速度）
- 紧急减速度：5.0 m/s²（紧急情况下的最大减速度）

#### 5.1.4 算法优势
- **平滑性**：五次多项式确保速度和加速度的变化都是连续的，没有突变
- **安全性**：内置了多种安全限制，防止碰撞和急刹
- **适应性**：根据不同情况自动调整控制策略
- **舒适性**：模拟人类驾驶员的驾驶习惯，提供平稳的乘坐体验

这种车速控制算法能让CAV车辆在各种情况下都能安全、平滑地行驶，提高交通效率的同时保证乘客舒适。

### 5.2 交通压力检测
程序通过**全面压力检测**算法来判断道路拥堵情况，这是实现智能交通控制的基础。

#### 5.2.1 检测原理
传统的交通检测方法只统计停止的车辆，容易遗漏已经起步但仍在路口附近的车辆。本程序采用更全面的检测方式：

1. **遍历指定车道**：检查所有需要监测的车道
2. **获取车辆信息**：获取每个车道上的所有车辆
3. **计算距离**：精确计算每个车辆到停止线的距离
4. **判断压力**：只要车辆在检测范围内，就算作有效交通压力
5. **返回结果**：返回总车辆数作为该方向的交通压力值

#### 5.2.2 检测范围
检测范围是一个关键参数，可以根据需要灵活调整：
- **绿灯延长**：使用80米检测范围（检测侧向道路压力）
- **红灯早断**：使用150米检测范围（确保当前方向没有车辆）
- **默认设置**：200米（常规检测）

#### 5.2.3 算法优势
- **全面性**：不会遗漏任何在范围内的车辆，无论是否移动
- **灵活性**：可以根据不同场景调整检测范围
- **鲁棒性**：内置错误处理，防止车道ID错误导致程序崩溃
- **实时性**：每0.1秒更新一次压力数据，确保决策及时

### 5.3 协同控制逻辑
协同控制是CAV Plus的核心功能，包括**信号优化**和**轨迹控制**两大部分，让CAV车辆能够更高效、安全地通行。

#### 5.3.1 信号优化
程序会根据CAV车辆的位置和道路拥堵情况，动态调整交通信号灯，让CAV车辆获得更好的通行条件。

##### 绿灯延长
当CAV车队正在通过路口，而绿灯即将结束时，程序会考虑延长绿灯时间：

1. **识别关键车辆**：找到车队中最后一辆车（尾车）
2. **计算到达时间**：
   ```
   到达时间 = 尾车到停止线的距离 / 尾车速度
   ```
3. **判断是否需要延长**：如果到达时间大于绿灯剩余时间，考虑延长
4. **检测侧向压力**：检查侧向道路（南北方向）的交通压力
5. **执行延长**：如果侧向压力小于阈值，延长绿灯时间

**触发条件**：
- 尾车距离停止线较远
- 到达时间大于绿灯剩余时间
- 侧向道路压力小于15辆
- 距离上次延长超过3秒

##### 红灯早断
当当前绿灯方向车辆较少，而CAV车辆在等待红灯时，程序会考虑提前结束当前绿灯：

1. **识别等待车辆**：找到等待红灯的CAV车队头车
2. **检查当前相位**：判断当前绿灯方向是否可以提前结束
3. **检测当前方向压力**：确保当前绿灯方向150米内没有车辆
4. **执行早断**：如果条件满足，提前跳转到黄灯

**触发条件**：
- 当前绿灯方向压力小于3辆
- 绿灯已经运行超过5秒
- CAV头车在200米检测范围内
- 距离上次信号调整超过5秒

#### 5.3.2 轨迹控制
轨迹控制让CAV车辆形成紧密的车队行驶，提高道路利用率，同时保证安全。

##### 车辆分组
程序会将同一路径上的CAV车辆分为一组，便于统一控制：
1. **定义路径**：预设CAV车辆的行驶路径（如东西直行）
2. **筛选车辆**：只处理符合条件的CAV车辆
3. **排序车辆**：按距离停止线的远近排序，形成车队

##### 头车控制
每队CAV车辆的第一辆车（头车）拥有特殊的控制逻辑：

1. **判断交通灯状态**：
   - 如果是绿灯，加速通过路口
   - 如果是红灯，提前减速停车
2. **计算停车距离**：使用五次多项式算法规划平滑的停车轨迹
3. **动态调整**：根据绿灯剩余时间调整行驶策略

##### 跟随车控制
跟随车会模仿头车的行为，保持安全距离：

1. **判断前车状态**：
   - 如果前车已经进入路口，而当前是红灯，自动变为临时头车
   - 否则，执行跟随逻辑
2. **计算安全距离**：
   ```
   安全距离 = 车辆长度 + 编队最小间距 + 停止缓冲区
   ```
3. **执行跟随**：使用五次多项式算法平滑跟随前车
4. **颜色标识**：不同状态的车辆显示不同颜色，便于观察

##### 全局清理
程序会定期释放不再受控的车辆，恢复其正常行驶状态：
- 将车辆颜色恢复为黄色
- 取消速度控制，恢复自主行驶
- 重置车辆参数

#### 5.3.3 协同控制优势
- **提高通行效率**：减少CAV车辆的等待时间
- **减少能源消耗**：避免急加速急刹车
- **提高道路利用率**：车辆编队行驶，减少车距
- **增强安全性**：实时监测，提前预警
- **自适应调整**：根据交通情况动态优化

通过这些协同控制策略，CAV Plus程序能够实现智能网联汽车的高效、安全通行，为未来智能交通系统提供参考。

## 6. 主仿真流程

1. **初始化**：启动SUMO仿真，加载路网和车辆数据
2. **设置视图**：如果启用GUI，调整视角和显示模式
3. **循环仿真**：
   - 执行一个仿真步长（0.1秒）
   - 如果启用了协同逻辑，执行信号优化和轨迹控制
   - 保存仿真数据
   - 重复直到所有车辆离开路网
4. **结束仿真**：关闭SUMO连接，保存最终结果

## 7. 总结

CAV Plus 程序是一个智能交通仿真工具，通过以下方式提高交通效率：

- **信号优先**：让CAV车辆获得更好的通行条件，减少等待时间
- **轨迹控制**：让CAV车辆形成紧密编队，提高道路利用率
- **平滑控制**：减少急加速急刹车，降低能耗和排放
- **动态调整**：根据实时交通情况优化信号控制

这个程序可以用于测试和评估CAV协同控制策略，为未来智能交通系统的设计提供参考。

## 8. 可视化颜色说明

在GUI模式下，车辆会显示不同颜色，代表不同的状态：

| 颜色 | 状态 |
|------|------|
| 绿色 | 正常行驶 |
| 橙色 | 正在减速停车或等待 |
| 青色 | 正在协同加速 |
| 黄色 | 不受控的车辆 |

通过这些颜色，可以直观地观察到CAV车辆的协同行为和信号优化效果。

## 9. 结果分析参数 (Result Analysis Parameters)
CAV Plus会生成详细的仿真结果数据，用于评估协同控制策略的效果。以下是主要分析参数的解释和计算公式：

| 参数 | 英文名称 | 解释 | 计算公式 |
|------|----------|------|----------|
| 平均延误时间 | Average Delay Time | 车辆实际旅行时间与自由流旅行时间的差值 | `平均延误时间 = (总实际旅行时间 - 总自由流旅行时间) / 总车辆数` |
| 平均停车次数 | Average Stopping Number | 每辆车在仿真过程中的平均停车次数 | `平均停车次数 = 总停车次数 / 总车辆数` |
| 平均旅行时间 | Average Travel Time | 车辆从起点到终点的平均行驶时间 | `平均旅行时间 = 总旅行时间 / 总车辆数` |
| 最大队列长度 | Maximum Queue Length | 仿真过程中出现的最大排队车辆数 | `最大队列长度 = max(各时间步的队列长度)` |
| 通行能力 | Capacity | 单位时间内通过路口的最大车辆数 | `通行能力 = 总通过车辆数 / 仿真时间` |
| 燃油消耗 | Fuel Consumption | 所有车辆的总燃油消耗 | 由SUMO仿真引擎直接计算，基于车辆类型和运行状态 |

**自由流旅行时间 (Free Flow Travel Time)**：车辆在理想条件下（无拥堵、无信号控制）的旅行时间
**自由流速度 (Free Flow Speed)**：道路设计的最高允许速度（本例中为16.67 m/s）

这些参数可以帮助我们评估CAV协同控制策略的效果，比较不同控制模式下的交通效率提升。